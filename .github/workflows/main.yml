name: Build Ebook Daily

on:
  # schedule:
  #   - cron: '0 0 * * *' # 每天 UTC 0点运行
  workflow_dispatch:      # 允许手动触发

permissions:
  contents: write # 赋予写入权限（如果你以后要发布 release 需要）

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 拉取代码
    - name: Checkout code
      uses: actions/checkout@v4 # 升级到 v4

    # 2. 配置 Python 环境
    - name: Set up Python
      uses: actions/setup-python@v5 # 升级到 v5
      with:
        python-version: '3.9'

    # 3. 安装 Python 依赖
    - name: Install Python dependencies
      run: |
        pip install requests feedparser

    # 4. 运行脚本生成 Recipe
    - name: Generate Recipe File
      run: |
        python gen_recipe.py
        echo "Recipe generated successfully."
        # 简单检查文件是否存在
        if [ -f "site.recipe" ]; then
          echo "site.recipe found."
        else
          echo "Error: site.recipe not found!"
          exit 1
        fi

    # 5. 安装 Calibre 系统依赖 (关键修复步骤)
    # libegl1, libopengl0, libxcb-cursor0 是 Calibre 7.x+ 在 Linux 上的常见依赖
    - name: Install Calibre Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libegl1 libopengl0 libxcb-cursor0 libxkbcommon-x11-0

    # 6. 安装 Calibre
    - name: Install Calibre
      run: |
        sudo -v && wget -nv -O- https://download.calibre-ebook.com/linux-installer.sh | sudo sh /dev/stdin

# 7. 转换电子书
    - name: Convert Recipe to EPUB
      run: |
        # 移除了不支持的 --timeout 参数
        # 保留 -vv (详细日志) 和 --output-profile
        xvfb-run ebook-convert site.recipe Jidujiao_Education.epub --output-profile=tablet -vv
        
    # 8. 上传结果 (修复: 升级到 v4)
    - name: Upload Ebook Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Jidujiao-Ebook
        path: Jidujiao_Education.epub
        retention-days: 5
