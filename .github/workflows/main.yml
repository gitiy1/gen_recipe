name: Build Ebook Daily

# 触发条件：
# 1. 每天 UTC 时间 0点 (北京时间早上8点) 自动运行
# 2. 也可以手动点击 Star 旁边的 "Run workflow" 按钮触发
on:
  # schedule:
  #   - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 拉取代码
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. 配置 Python 环境
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. 安装 Python 依赖
    - name: Install Python dependencies
      run: |
        pip install requests feedparser

    # 4. 运行你的脚本，生成 .recipe 文件
    - name: Generate Recipe File
      run: |
        python gen_recipe.py
        echo "Recipe generated successfully."
        ls -l site.recipe

    # 5. 安装 Calibre (使用官方静默安装脚本)
    - name: Install Calibre
      run: |
        sudo -v && wget -nv -O- https://download.calibre-ebook.com/linux-installer.sh | sudo sh /dev/stdin

    # 6. 使用 ebook-convert 生成电子书
    # 语法: ebook-convert "输入配方" "输出文件" [参数]
    - name: Convert Recipe to EPUB
      run: |
        # 增加超时参数 --timeout，防止大文件抓取中断
        # -vv 开启详细日志，方便出错调试
        ebook-convert site.recipe Jidujiao_Education.epub --output-profile=tablet -vv

    # 7. (可选) 上传为 Artifacts，可以直接下载，保留 90 天
    - name: Upload Ebook Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Jidujiao-Ebook
        path: Jidujiao_Education.epub
        retention-days: 5
    
    # 8. (高级可选) 自动发布到 Releases (如果你需要永久链接)
    # 需要在仓库 Settings -> Secrets 设置 GITHUB_TOKEN (通常默认就有)
    # - name: Release
    #   uses: softprops/action-gh-release@v1
    #   if: startsWith(github.ref, 'refs/tags/')
    #   with:
    #     files: Jidujiao_Education.epub
