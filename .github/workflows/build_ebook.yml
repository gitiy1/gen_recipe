name: Build Ebook with Nix

on:
  # schedule:
  #   - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 拉取代码
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. 安装 Nix (使用 Determinate Systems 的安装器，非常快且稳定)
    - name: Install Nix
      uses: determinate-systems/nix-installer-action@v9

    # 3. 启用 Magic Nix Cache (自动缓存 Nix Store 到 GitHub Cache)
    # 只要 flake.lock 不变，第二次运行几乎不需要下载任何包
    - name: Setup Magic Nix Cache
      uses: determinate-systems/magic-nix-cache-action@v2

    # 4. 生成 Recipe
    # 使用 `nix develop --command` 在 Nix 环境中运行命令
    - name: Generate Recipe File
      run: |
        nix develop --command python gen_recipe.py
        
        if [ -f "site.recipe" ]; then
          echo "Recipe generated."
        else
          echo "Error: site.recipe not found!"
          exit 1
        fi

    # 5. 转换电子书
    # 直接调用 nix 环境中的 xvfb-run 和 ebook-convert
    # 不需要再去处理 libEGL 等依赖，Nix 包已经封装好了 RPATH
    - name: Convert to EPUB
      run: |
        nix develop --command xvfb-run ebook-convert site.recipe Jidujiao_Education.epub --output-profile=tablet -vv

    # 6. 上传结果
    - name: Upload Ebook Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Jidujiao-Ebook
        path: Jidujiao_Education.epub
        retention-days: 5
