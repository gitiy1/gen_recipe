name: Build Split Ebooks With Nix

on:
  # schedule:
  #   - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main
      
    - name: Setup Magic Nix Cache
      uses: DeterminateSystems/magic-nix-cache-action@main

    - name: Generate Recipe Files
      run: |
        # nix develop --command python gen_edu_recipe_split.py
        rm tiny_lamb_recipe.recipe 
        # (确保这里是你实际要运行的脚本)
        nix develop --command python gen_reformedbeginner_recipe_split.py
        echo "Recipe generation complete."
        ls -l *.recipe

    - name: Convert All Recipes to EPUB
      run: |
        mkdir -p output_epubs
        
        for recipe in *.recipe; do
          filename=$(basename "$recipe" .recipe)
          echo "=========================================="
          echo "Converting: $recipe -> $filename.epub"
          echo "=========================================="
          
          # 重试逻辑：最多尝试 3 次
          MAX_RETRIES=3
          count=0
          success=false
          
          while [ $count -lt $MAX_RETRIES ]; do
            # 运行转换命令
            if nix develop --command xvfb-run ebook-convert "$recipe" "output_epubs/$filename.epub" --output-profile=kindle_pw; then
              success=true
              break
            else
              count=$((count+1))
              echo "!!! Failure detected. Retrying ($count/$MAX_RETRIES) in 10 seconds..."
              sleep 10
            fi
          done
          
          if [ "$success" = false ]; then
            echo "!!! Failed to convert $recipe after $MAX_RETRIES attempts."
            # 这里可以选择 exit 1 让整个 Action 失败，或者继续处理下一本
            # 为了尽可能拿到部分结果，我们不退出，继续下一本
          fi
          
        done

    - name: Upload Ebook Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Jidujiao-Website-Series-Ebooks
        path: output_epubs/*.epub
        retention-days: 5
